<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8" />
<title>Hälytykset</title>
<style>
/* Minimal inline styles preserved from original */
body { font-family: Arial, sans-serif; padding: 30px; background: #f4f4f4; }
table { width:100%; border-collapse: collapse; background: white; }
th, td { border: 1px solid #ccc; padding: 10px; text-align:left; }
.no-results { text-align:center; padding:20px; color:#666; font-style:italic; }
button { padding:6px 10px; margin-right:6px; }
.modal-bg { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center; }
.modal { background:white; padding:20px; border-radius:8px; min-width:300px; }
</style>
</head>
<body>
<h2>Hälytykset</h2>
<div id="authArea">
  <div id="authForms">
    <input id="email" placeholder="Sähköposti"><br><br>
    <input id="password" type="password" placeholder="Salasana"><br><br>
    <button id="btnRegister">Rekisteröidy</button>
    <button id="btnLogin">Kirjaudu</button>
  </div>
  <div id="userInfo" style="display:none;">
    <span id="userEmail"></span>
    <button id="btnLogout">Kirjaudu ulos</button>
  </div>
</div>
<div style="margin-top:20px;">
  <input id="input" type="text" placeholder="Osoite, Hälytys, Kello (esim 1240 tai 9)" style="width:60%">
  <button id="btnAdd">Lisää</button>
</div>
<table id="alertTable">
  <thead><tr><th>Osoite</th><th>Hälytys</th><th>Kello</th><th>Toiminnot</th></tr></thead>
  <tbody></tbody>
</table>
<div id="message"></div>
<script>
  const API_BASE = '';
  let token = localStorage.getItem('token') || null;
  let user = JSON.parse(localStorage.getItem('user')||'null');
  const setMessage = (m) => { document.getElementById('message').textContent = m; setTimeout(()=>document.getElementById('message').textContent='',2500); }
  function updateAuthUI() {
    if (token && user) {
      document.getElementById('authForms').style.display='none';
      document.getElementById('userInfo').style.display='block';
      document.getElementById('userEmail').textContent = user.email;
    } else {
      document.getElementById('authForms').style.display='block';
      document.getElementById('userInfo').style.display='none';
    }
  }
  updateAuthUI();
  document.getElementById('btnRegister').addEventListener('click', async ()=>{
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    if (!email || !password) return setMessage('Täytä kentät');
    const res = await fetch('/api/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});
    const j = await res.json();
    if (res.ok) setMessage('Rekisteröityminen onnistui. Kirjaudu sisään.');
    else setMessage(j.error || 'Virhe');
  });
  document.getElementById('btnLogin').addEventListener('click', async ()=>{
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    if (!email || !password) return setMessage('Täytä kentät');
    const res = await fetch('/api/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,password})});
    const j = await res.json();
    if (res.ok) {
      token = j.token; user = j.user;
      localStorage.setItem('token', token); localStorage.setItem('user', JSON.stringify(user));
      updateAuthUI(); loadAlerts();
    } else {
      setMessage(j.error || 'Kirjautuminen epäonnistui');
    }
  });
  document.getElementById('btnLogout').addEventListener('click', ()=>{
    token = null; user = null; localStorage.removeItem('token'); localStorage.removeItem('user'); updateAuthUI(); render([]);
  });
  document.getElementById('btnAdd').addEventListener('click', async ()=>{
    const val = document.getElementById('input').value.trim();
    const parts = val.split(',').map(s=>s.trim());
    if (parts.length!==3) return setMessage('Syötä Osoite, Hälytys, Kello (esim "Katu 1, Palo, 1245")');
    const [address, alertText, timeRaw] = parts;
    const time = formatTime(timeRaw);
    if (!isValidTime(time)) return setMessage('Tuntematon kellonaika');
    const res = await fetch('/api/alerts', { method:'POST', headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer '+token }, body: JSON.stringify({ address, alert: alertText, time }) });
    if (!res.ok) { const j=await res.json(); return setMessage(j.error||'Virhe lisättäessä'); }
    document.getElementById('input').value=''; setMessage('Lisätty'); loadAlerts();
  });
  function formatTime(t) {
    const digits = t.replace(/\D/g,'');
    if (digits.length<=2) return digits.padStart(2,'0')+':00';
    if (digits.length===3) return digits[0]+':'+digits.slice(1).padStart(2,'0');
    return digits.slice(0,-2).padStart(2,'0')+':'+digits.slice(-2);
  }
  function isValidTime(t) {
    const [h,m]=t.split(':').map(Number); return h>=0 && h<24 && m>=0 && m<60;
  }
  async function loadAlerts(){
    if (!token) return render([]);
    const res = await fetch('/api/alerts', { headers: { 'Authorization': 'Bearer '+token } });
    if (!res.ok) { render([]); return; }
    const j = await res.json();
    render(j.alerts || []);
  }
  function render(alerts){
    const tbody = document.querySelector('#alertTable tbody');
    tbody.innerHTML='';
    if (!alerts.length) { tbody.innerHTML='<tr><td colspan="4" class="no-results">Ei hälytyksiä</td></tr>'; return; }
    alerts.forEach(a=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${a.address}</td><td>${a.alert}</td><td>${a.time}</td><td>
        <button data-id="${a.id}" class="btnDel">Poista</button>
        <button data-id="${a.id}" class="btnTogglePin">${a.pinned? 'Poista pinnaus':'Pinnaa'}</button>
      </td>`;
      tbody.appendChild(tr);
    });
    document.querySelectorAll('.btnDel').forEach(b=>b.addEventListener('click', async (e)=>{
      const id = e.target.dataset.id;
      await fetch('/api/alerts/'+id, { method:'DELETE', headers:{ 'Authorization':'Bearer '+token } });
      loadAlerts();
    }));
    document.querySelectorAll('.btnTogglePin').forEach(b=>b.addEventListener('click', async (e)=>{
      const id = e.target.dataset.id;
      const row = alerts.find(x=>x.id===id);
      await fetch('/api/alerts/'+id, { method:'PUT', headers:{ 'Content-Type':'application/json','Authorization':'Bearer '+token }, body: JSON.stringify({ pinned: !row.pinned }) });
      loadAlerts();
    }));
  }
  // Auto-load if logged in
  if (token) loadAlerts();
</script>
</body>
</html>
